{% extends "base.html" %}

{% block title %}Live Attendance - Attendance System{% endblock %}

{% block content %}
<div x-data="liveAttendance()" x-init="init()">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Live Attendance</h2>
        <p class="text-gray-600">Real-time face recognition attendance system</p>
    </div>

    <!-- Camera Controls -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">Camera Settings</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Camera Type</label>
                <select x-model="cameraType" class="w-full border border-gray-300 rounded-md px-3 py-2">
                    <option value="0">Default Camera (Webcam)</option>
                    <option value="1">DroidCam (IP Camera)</option>
                </select>
            </div>
            
            <div x-show="cameraType === '1'">
                <label class="block text-sm font-medium text-gray-700 mb-2">IP Address</label>
                <input x-model="ipAddress" type="text" placeholder="192.168.29.28" 
                       class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            
            <div class="flex items-end">
                <button @click="toggleCamera()" 
                        :class="isStreaming ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'"
                        class="w-full text-white py-2 px-4 rounded transition">
                    <span x-text="isStreaming ? 'Stop Camera' : 'Start Camera'"></span>
                </button>
            </div>
        </div>
        
        <div x-show="message" :class="messageType === 'error' ? 'text-red-600' : 'text-green-600'" 
             class="text-sm mt-2" x-text="message"></div>
    </div>

    <!-- Notifications -->
    <div class="fixed top-4 right-4 z-50 space-y-2" x-show="notifications.length > 0">
        <template x-for="notification in notifications" :key="notification.id">
            <div x-show="notification.show"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-x-0"
                 x-transition:leave-end="opacity-0 transform translate-x-full"
                 :class="notification.type === 'success' ? 'bg-green-500' : 'bg-blue-500'"
                 class="text-white px-6 py-4 rounded-lg shadow-lg max-w-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg x-show="notification.type === 'success'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <svg x-show="notification.type === 'info'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="font-medium" x-text="notification.title"></p>
                        <p class="text-sm opacity-90" x-text="notification.message"></p>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Video Feed and Stats -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Video Feed -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Live Feed</h3>
                <div class="relative">
                    <div x-show="!isStreaming" class="bg-gray-200 rounded-lg flex items-center justify-center h-96">
                        <div class="text-center text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <p>Camera not started</p>
                            <p class="text-sm">Click "Start Camera" to begin</p>
                        </div>
                    </div>
                    
                    <!-- Video Feed with Overlay -->
                    <div x-show="isStreaming" class="relative">
                        <img src="/video_feed" class="w-full rounded-lg" alt="Live Feed">
                        
                        <!-- Face Detection Overlay -->
                        <div x-show="performance.faces_detected > 0" 
                             class="absolute top-4 left-4 bg-green-500 text-white px-3 py-2 rounded-lg shadow-lg animate-pulse">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-medium" x-text="`${performance.faces_detected} Face(s) Detected`"></span>
                            </div>
                        </div>
                        
                        <!-- Recording Indicator -->
                        <div class="absolute top-4 right-4 flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-white bg-black bg-opacity-50 px-2 py-1 rounded text-sm">LIVE</span>
                        </div>
                        
                        <!-- Status Indicator -->
                        <div class="absolute bottom-4 left-4">
                            <div :class="currentStatus === 'Present' ? 'bg-green-500' : 'bg-orange-500'" 
                                 class="text-white px-3 py-2 rounded-lg shadow-lg">
                                <span class="font-medium" x-text="`Status: ${currentStatus}`"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Stats -->
        <div class="space-y-6">
            <!-- Today's Summary -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Today's Summary</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Present</span>
                        <span class="font-semibold text-green-600" x-text="summary.Present"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Late</span>
                        <span class="font-semibold text-orange-600" x-text="summary.Late"></span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-2">
                        <span class="text-gray-600 font-medium">Total</span>
                        <span class="font-bold text-blue-600" x-text="summary.Total"></span>
                    </div>
                </div>
            </div>

            <!-- Current Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Time</span>
                        <span class="font-semibold" x-text="currentTime"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status</span>
                        <span :class="currentStatus === 'Present' ? 'text-green-600' : 'text-orange-600'" 
                              class="font-semibold" x-text="currentStatus"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Camera</span>
                        <span :class="isStreaming ? 'text-green-600' : 'text-red-600'" 
                              class="font-semibold" x-text="isStreaming ? 'Active' : 'Inactive'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Faces Detected</span>
                        <div class="flex items-center">
                            <span class="font-semibold text-blue-600 mr-2" x-text="performance.faces_detected || 0"></span>
                            <div x-show="performance.faces_detected > 0" 
                                 class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">AI Mode</span>
                        <span :class="performance.face_recognition_available ? 'text-green-600' : 'text-orange-600'" 
                              class="font-semibold text-xs" x-text="performance.face_recognition_available ? 'Full AI' : 'Demo'"></span>
                    </div>
                </div>
            </div>

            <!-- Face Detection Alert -->
            <div x-show="performance.faces_detected > 0" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 class="bg-green-50 border border-green-200 rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h4 class="text-sm font-medium text-green-800">Face Detected!</h4>
                        <p class="text-sm text-green-700" x-text="`${performance.faces_detected} face(s) in view`"></p>
                    </div>
                </div>
            </div>

            <!-- Recent Recognitions -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Recent Recognitions</h3>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="record in recentRecords.slice(0, 5)" :key="record.name + record.time">
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div>
                                <div class="font-medium text-sm" x-text="record.name"></div>
                                <div class="text-xs text-gray-500" x-text="record.time"></div>
                            </div>
                            <span :class="record.status === 'Present' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'" 
                                  class="px-2 py-1 rounded text-xs" x-text="record.status"></span>
                        </div>
                    </template>
                    <div x-show="recentRecords.length === 0" class="text-center py-4 text-gray-500 text-sm">
                        No recognitions yet
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function liveAttendance() {
    return {
        isStreaming: false,
        cameraType: '0',
        ipAddress: '192.168.29.28',
        message: '',
        messageType: 'info',
        summary: { Present: 0, Late: 0, Total: 0 },
        recentRecords: [],
        currentTime: '',
        currentStatus: 'Present',
        performance: {},
        notifications: [],
        lastFaceCount: 0,
        lastRecognitionCount: 0,
        
        init() {
            this.updateTime();
            this.updateStatus();
            this.loadTodayData();
            
            // Update time every second
            setInterval(() => {
                this.updateTime();
                this.updateStatus();
            }, 1000);
            
            // Refresh data every 5 seconds when streaming
            setInterval(() => {
                if (this.isStreaming) {
                    this.loadTodayData();
                    this.loadPerformance();
                }
            }, 5000);
        },
        
        updateTime() {
            this.currentTime = new Date().toLocaleTimeString();
        },
        
        updateStatus() {
            const hour = new Date().getHours();
            this.currentStatus = hour < 12 ? 'Present' : 'Late';
        },
        
        async toggleCamera() {
            if (this.isStreaming) {
                await this.stopCamera();
            } else {
                await this.startCamera();
            }
        },
        
        async startCamera() {
            try {
                const response = await fetch('/api/camera/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        camera_type: this.cameraType,
                        ip_address: this.ipAddress
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.isStreaming = true;
                    this.message = data.message;
                    this.messageType = 'success';
                } else {
                    this.message = data.message;
                    this.messageType = 'error';
                }
            } catch (error) {
                this.message = 'Error starting camera: ' + error.message;
                this.messageType = 'error';
            }
        },
        
        async stopCamera() {
            try {
                const response = await fetch('/api/camera/stop', {
                    method: 'POST'
                });
                
                const data = await response.json();
                this.isStreaming = false;
                this.message = data.message;
                this.messageType = 'success';
            } catch (error) {
                this.message = 'Error stopping camera: ' + error.message;
                this.messageType = 'error';
            }
        },
        

        
        async loadPerformance() {
            try {
                const response = await fetch('/api/performance');
                const data = await response.json();
                
                // Check for face detection changes
                if (data.faces_detected > this.lastFaceCount) {
                    this.showNotification('info', 'Face Detected!', `${data.faces_detected} face(s) in view`);
                }
                
                this.lastFaceCount = data.faces_detected;
                this.performance = data;
            } catch (error) {
                console.error('Error loading performance data:', error);
            }
        },
        
        async loadTodayData() {
            try {
                const response = await fetch('/api/attendance/today');
                const data = await response.json();
                
                // Check for new attendance records
                if (data.records.length > this.lastRecognitionCount) {
                    const newRecords = data.records.slice(0, data.records.length - this.lastRecognitionCount);
                    newRecords.forEach(record => {
                        this.showNotification('success', 'Attendance Marked!', 
                            `${record.name} - ${record.status} at ${record.time}`);
                    });
                }
                
                this.lastRecognitionCount = data.records.length;
                this.summary = data.summary;
                this.recentRecords = data.records;
            } catch (error) {
                console.error('Error loading attendance data:', error);
            }
        },
        
        showNotification(type, title, message) {
            const id = Date.now();
            const notification = {
                id: id,
                type: type,
                title: title,
                message: message,
                show: true
            };
            
            this.notifications.push(notification);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index > -1) {
                    this.notifications[index].show = false;
                    // Remove from array after animation
                    setTimeout(() => {
                        this.notifications.splice(index, 1);
                    }, 300);
                }
            }, 4000);
        }
    }
}
</script>
{% endblock %}